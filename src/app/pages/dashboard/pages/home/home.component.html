<!-- User Card - Always visible -->
<mat-card class="mb-3 user-card">
  <mat-card-title>
    <ng-container *ngIf="currentUser$ | async as user; else loadingUser">
      {{ user.Username }}
    </ng-container>
    <ng-template #loadingUser>
      Åadowanie...
    </ng-template>
  </mat-card-title>
  
  <!-- Role Section -->
  <div class="role-section" *ngIf="currentUser$ | async as user">
    <div class="role-display" [ngClass]="'role-' + user.Role.toLowerCase()">
      <div class="role-icon">{{ getRoleIcon(user.Role) }}</div>
      <div class="role-info">
        <div class="role-title">{{ getRoleDisplayName(user.Role) }}</div>
        <div class="role-subtitle">{{ getRoleDescription(user.Role) }}</div>
      </div>
    </div>
  </div>
  
  <mat-card-subtitle>
    MiÅ‚ego dnia! ğŸŒŸ
  </mat-card-subtitle>
</mat-card>

<!-- Role-specific content -->
<ng-container *ngIf="currentUser$ | async as user">
  
  <!-- ADMIN DASHBOARD -->
  <div *ngIf="user.Role === 'admin'" class="admin-dashboard">
    <div class="dashboard-grid">
      <!-- System Metrics -->
      <mat-card class="metric-card">
        <mat-card-title>ğŸ“Š Metryki systemu</mat-card-title>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-value">{{ totalUsers$ | async }}</div>
            <div class="metric-label">UÅ¼ytkownikÃ³w</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{{ totalReservations$ | async }}</div>
            <div class="metric-label">Rezerwacji</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{{ totalClasses$ | async }}</div>
            <div class="metric-label">ZajÄ™Ä‡</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{{ totalRooms$ | async }}</div>
            <div class="metric-label">Sal</div>
          </div>
        </div>
      </mat-card>
      
      <!-- Quick Actions -->
      <mat-card class="action-card admin-actions">
        <mat-card-title>âš¡ Szybkie akcje</mat-card-title>
        <div class="action-buttons">
          <button mat-raised-button color="primary" class="action-btn admin-btn" (click)="navigateToUserManagement()">
            ğŸ‘¥ ZarzÄ…dzaj uÅ¼ytkownikami
          </button>
          <button mat-raised-button color="accent" class="action-btn admin-btn" (click)="navigateToRoomManagement()">
            ğŸ¢ ZarzÄ…dzaj salami
          </button>
        </div>
      </mat-card>
    </div>
  </div>
  
  <!-- TRAINER DASHBOARD -->
  <div *ngIf="user.Role === 'trener'" class="trainer-dashboard">
    <div class="dashboard-grid">
      <!-- My Classes -->
      <mat-card class="classes-card">
        <mat-card-title>ğŸ’ª Moje zajÄ™cia</mat-card-title>
        <div class="upcoming-classes">
          <div *ngFor="let event of (myClasses$ | async)" class="class-item">
            <div class="class-time">{{ event.start | date:"HH:mm" }}</div>
            <div class="class-details">
              <div class="class-name">{{ event.title }}</div>
              <div class="class-room">{{ event.roomName }}</div>
            </div>
          </div>
          <div *ngIf="(myClasses$ | async)?.length === 0" class="no-classes">
            Brak nadchodzÄ…cych zajÄ™Ä‡
          </div>
        </div>
      </mat-card>
      
      <!-- Quick Actions -->
      <mat-card class="action-card trainer-actions">
        <div class="action-buttons">
          <button mat-raised-button color="primary" class="action-btn trainer-btn" (click)="organizeClass()">
            ğŸ’ª Zorganizuj zajÄ™cia
          </button>
        </div>
      </mat-card>
    </div>
    
    <!-- Calendar for trainers -->
    <div class="calendar-container">
      <app-custom-calendar
        [events]="(trainerEvents$ | async) || []"
        [viewDate]="viewDate"
        (eventClick)="onEventClick($event)"
        (dateClick)="onDateClick($event)"
        (monthChange)="onMonthChange($event)"
        (reservationDeleted)="onReservationDeleted()"
        (eventDeleted)="onEventDeleted($event)"
      ></app-custom-calendar>
    </div>
  </div>
  
  <!-- RECEPTIONIST DASHBOARD -->
  <div *ngIf="user.Role === 'receptionist'" class="receptionist-dashboard">
    <div class="dashboard-grid">
      <!-- System Metrics -->
      <mat-card class="metric-card">
        <mat-card-title>ğŸ“Š Metryki systemu</mat-card-title>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-value">{{ totalUsers$ | async }}</div>
            <div class="metric-label">UÅ¼ytkownikÃ³w</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{{ totalReservations$ | async }}</div>
            <div class="metric-label">Rezerwacji</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{{ totalClasses$ | async }}</div>
            <div class="metric-label">ZajÄ™Ä‡</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{{ totalRooms$ | async }}</div>
            <div class="metric-label">Sal</div>
          </div>
        </div>
      </mat-card>
      
      <!-- Quick Actions -->
      <mat-card class="action-card admin-actions">
        <mat-card-title>âš¡ Szybkie akcje</mat-card-title>
        <div class="action-buttons">
          <button mat-raised-button color="primary" class="action-btn admin-btn" (click)="navigateToUserManagement()">
            ğŸ‘¥ ZarzÄ…dzaj uÅ¼ytkownikami
          </button>
          <button mat-raised-button color="accent" class="action-btn admin-btn" (click)="navigateToReservations()">
            ğŸ“… ZarzÄ…dzaj rezerwacjami
          </button>
        </div>
      </mat-card>
    </div>
  </div>
  
  <!-- REGULAR USER DASHBOARD -->
  <div *ngIf="user.Role === 'regular'" class="user-dashboard">
    <div class="dashboard-grid">
      <!-- My Reservations -->
      <mat-card class="my-reservations-card">
        <mat-card-title>ğŸ“… Moje rezerwacje</mat-card-title>
        <dl>
          <dt>ğŸ¯ NajbliÅ¼szy trening</dt>
          <dd>
            <ng-container *ngIf="(closestEvent$|async) as event; else noUpcomingEvents">
              {{ event.title }} ({{ event.start | date:"dd.MM.yyyy 'o' HH:mm" }})
            </ng-container>
            <ng-template #noUpcomingEvents>
              <span class="no-events">Brak nadchodzÄ…cych treningÃ³w</span>
            </ng-template>
          </dd>
          <dt>ğŸƒâ€â™‚ï¸ IloÅ›Ä‡ odbytych treningÃ³w</dt>
          <dd class="mb-0">
            <span class="events-count">{{ pastEventsCount$ | async }}</span>
            <span class="events-label">treningÃ³w</span>
          </dd>
  </dl>
</mat-card>

      <!-- Quick Actions -->
      <mat-card class="action-card user-actions">
        <div class="action-buttons">
          <button mat-raised-button color="primary" class="action-btn user-btn" (click)="openActionModal()">
            ğŸ¢ Zarezerwuj salÄ™ lub zapisz siÄ™ na zajÄ™cia
          </button>
          
          <!-- Become Trainer Button -->
          <button mat-stroked-button class="become-trainer-btn" (click)="openBecomeTrainerModal()">
            ğŸ’ª ZostaÅ„ trenerem
          </button>
        </div>
      </mat-card>
    </div>
    
    <!-- Calendar for regular users -->
    <div class="calendar-container">
      <app-custom-calendar
        [events]="(formattedEvents$ | async) || []"
    [viewDate]="viewDate"
        (eventClick)="onEventClick($event)"
        (dateClick)="onDateClick($event)"
        (monthChange)="onMonthChange($event)"
        (reservationDeleted)="onReservationDeleted()"
        (eventDeleted)="onEventDeleted($event)"
      ></app-custom-calendar>
    </div>
  </div>
  
</ng-container>

<!-- Action Selection Modal -->
<div class="action-modal-overlay" *ngIf="showActionModal" (click)="closeActionModal()">
  <div class="action-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Wybierz akcjÄ™</h3>
      <button class="close-btn" (click)="closeActionModal()">Ã—</button>
    </div>
    
    <div class="modal-content">
      <!-- User Actions -->
      <div *ngIf="(currentUser$ | async)?.Role === 'regular'" class="action-options">
        <button class="action-option-btn" (click)="reserveRoom()">
          <div class="option-icon">ğŸ¢</div>
          <div class="option-content">
            <div class="option-title">Zarezerwuj salÄ™</div>
            <div class="option-description">Zarezerwuj salÄ™ na okreÅ›lony czas</div>
          </div>
        </button>
        
        <button class="action-option-btn" (click)="signUpForClass()">
          <div class="option-icon">ğŸ’ª</div>
          <div class="option-content">
            <div class="option-title">Zapisz siÄ™ na zajÄ™cia</div>
            <div class="option-description">DoÅ‚Ä…cz do zajÄ™Ä‡ grupowych</div>
          </div>
        </button>
      </div>
      
      <!-- Trainer Actions -->
      <div *ngIf="(currentUser$ | async)?.Role === 'trainer'" class="action-options">
        <button class="action-option-btn" (click)="organizeClass()">
          <div class="option-icon">ğŸ’ª</div>
          <div class="option-content">
            <div class="option-title">Zorganizuj zajÄ™cia</div>
            <div class="option-description">StwÃ³rz nowe zajÄ™cia grupowe</div>
          </div>
        </button>
        
        <button class="action-option-btn" (click)="reserveRoom()">
          <div class="option-icon">ğŸ¢</div>
          <div class="option-content">
            <div class="option-title">Zarezerwuj salÄ™</div>
            <div class="option-description">Zarezerwuj salÄ™ na prywatny trening</div>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Room Reservation Modal -->
<div class="action-modal-overlay" *ngIf="showRoomReservationModal" (click)="closeRoomReservationModal()">
  <div class="action-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ¢ Rezerwacja sali</h3>
      <button class="close-btn" (click)="closeRoomReservationModal()">Ã—</button>
    </div>
    
    <div class="modal-content">
      <form class="reservation-form">
        <div class="form-group">
          <label>Sala *</label>
          <select [(ngModel)]="roomReservationData.roomId" name="roomId" required>
            <option value="">Wybierz salÄ™</option>
            <option *ngFor="let room of rooms$ | async" [value]="room.RoomID">
              {{ room.RoomName }}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Data *</label>
          <input type="date" [(ngModel)]="roomReservationData.date" name="date" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Godzina rozpoczÄ™cia *</label>
            <input type="time" [(ngModel)]="roomReservationData.startTime" name="startTime" required>
          </div>
          
          <div class="form-group">
            <label>Godzina zakoÅ„czenia *</label>
            <input type="time" [(ngModel)]="roomReservationData.endTime" name="endTime" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>Cel rezerwacji</label>
          <textarea [(ngModel)]="roomReservationData.purpose" name="purpose" 
                    placeholder="Opisz cel rezerwacji (opcjonalnie)"></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeRoomReservationModal()">
            Anuluj
          </button>
          <button type="button" class="btn-primary" (click)="submitRoomReservation()">
            Zarezerwuj salÄ™
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Class Organization Modal -->
<div class="action-modal-overlay" *ngIf="showClassOrganizationModal" (click)="closeClassOrganizationModal()">
  <div class="action-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ’ª Organizacja zajÄ™Ä‡</h3>
      <button class="close-btn" (click)="closeClassOrganizationModal()">Ã—</button>
    </div>
    
    <div class="modal-content">
      <form class="reservation-form">
        <div class="form-group">
          <label>TytuÅ‚ zajÄ™Ä‡ *</label>
          <input type="text" [(ngModel)]="classOrganizationData.title" name="title" 
                 placeholder="np. Joga dla poczÄ…tkujÄ…cych" required>
        </div>
        
        <div class="form-group">
          <label>Sala *</label>
          <select [(ngModel)]="classOrganizationData.roomId" name="roomId" required>
            <option value="">Wybierz salÄ™</option>
            <option *ngFor="let room of rooms$ | async" [value]="room.RoomID">
              {{ room.RoomName }}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Data *</label>
          <input type="date" [(ngModel)]="classOrganizationData.date" name="date" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Godzina rozpoczÄ™cia *</label>
            <input type="time" [(ngModel)]="classOrganizationData.startTime" name="startTime" required>
          </div>
          
          <div class="form-group">
            <label>Godzina zakoÅ„czenia *</label>
            <input type="time" [(ngModel)]="classOrganizationData.endTime" name="endTime" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>PojemnoÅ›Ä‡ (osoby)</label>
          <input type="number" [(ngModel)]="classOrganizationData.capacity" name="capacity" 
                 min="1" max="50" value="10">
        </div>
        
        <div class="form-group">
          <label>Opis zajÄ™Ä‡</label>
          <textarea [(ngModel)]="classOrganizationData.description" name="description" 
                    placeholder="Opisz zajÄ™cia (opcjonalnie)"></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeClassOrganizationModal()">
            Anuluj
          </button>
          <button type="button" class="btn-primary" (click)="submitClassOrganization()">
            UtwÃ³rz zajÄ™cia
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Class Signup Modal -->
<div class="action-modal-overlay" *ngIf="showClassSignupModal" (click)="closeClassSignupModal()">
  <div class="action-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ’ª Zapisz siÄ™ na zajÄ™cia</h3>
      <button class="close-btn" (click)="closeClassSignupModal()">Ã—</button>
    </div>
    
    <div class="modal-content">
      <div class="class-list">
        <div *ngFor="let classItem of availableClasses$ | async" class="class-item">
          <div class="class-info">
            <h4>{{ classItem.Title }}</h4>
            <p>ğŸ“… {{ formatClassDate(classItem.StartTime) }}</p>
            <p>ğŸ“ Sala {{ classItem.RoomID }}</p>
            <p>ğŸ‘¨â€ğŸ« {{ classItem.trainer?.Username || 'Trener' }}</p>
            <p>ğŸ‘¥ {{ getAvailableSpots(classItem) }}/{{ classItem.Capacity }} miejsc</p>
          </div>
          <button 
            class="btn-primary" 
            (click)="bookClass(classItem.ClassID)"
            [disabled]="isClassFull(classItem) || isUserAlreadyRegistered(classItem)">
            {{ isUserAlreadyRegistered(classItem) ? 'JuÅ¼ zapisany' : (isClassFull(classItem) ? 'Brak miejsc' : 'Zapisz siÄ™') }}
          </button>
        </div>
        
        <div *ngIf="(availableClasses$ | async)?.length === 0" class="no-classes">
          <p>Brak dostÄ™pnych zajÄ™Ä‡ do zapisania siÄ™.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Become Trainer Modal -->
<div class="action-modal-overlay" *ngIf="showBecomeTrainerModal" (click)="closeBecomeTrainerModal()">
  <div class="action-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ’ª ZostaÅ„ trenerem</h3>
      <button class="close-btn" (click)="closeBecomeTrainerModal()">Ã—</button>
    </div>
    
    <div class="modal-content">
      <div class="trainer-info-content">
        <p class="trainer-info-text">
          Chcesz zostaÄ‡ trenerem i prowadziÄ‡ wÅ‚asne zajÄ™cia? 
          Skontaktuj siÄ™ z naszÄ… recepcjÄ…, aby omÃ³wiÄ‡ szczegÃ³Å‚y!
        </p>
        <div class="contact-info">
          <div class="contact-item">
            <mat-icon class="contact-icon">email</mat-icon>
            <span class="contact-text">recepcja&#64;fitnessclub.pl</span>
          </div>
          <div class="contact-item">
            <mat-icon class="contact-icon">phone</mat-icon>
            <span class="contact-text">123 456 789</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
